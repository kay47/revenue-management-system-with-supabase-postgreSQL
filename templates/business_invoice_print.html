<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice #{{ invoice.invoice_no }} - Print</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #333;
            background: #fff;
            overflow-x: hidden;
        }

        .print-container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 8mm;
            background: #fff;
            position: relative;
            z-index: 1;
        }

        /* üîß FIXED WATERMARK */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.08;
            z-index: -1;
            pointer-events: none;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watermark img {
            width: 450px;
            height: auto;
            max-width: 60%;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .invoice-title h1 {
            font-size: 28pt;
            color: #667eea;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .invoice-title .invoice-number {
            font-size: 16pt;
            color: #333;
            font-weight: 600;
        }

        .company-info {
            text-align: right;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            gap: 12px;
        }

        .company-address {
            text-align: right;
            line-height: 1.5;
            font-size: 10pt;
        }

        .company-address strong {
            display: block;
            font-size: 10pt;
            margin-bottom: 3px;
        }

        .company-logo img {
            width: 75px;
            height: 75px;
            object-fit: contain;
        }

        .bill-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 20px;
        }

        .bill-to h3, .bill-data h3 {
            font-size: 11pt;
            color: #667eea;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .bill-to address {
            font-style: normal;
            line-height: 1.5;
            font-size: 10pt;
        }

        .info-line {
            margin-bottom: 3px;
            font-size: 10pt;
        }

        .info-line strong {
            display: inline-block;
            min-width: 110px;
        }

        .bill-data p {
            margin-bottom: 3px;
            font-size: 10pt;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .invoice-table thead {
            background: #667eea;
            color: #fff;
        }

        .invoice-table th {
            padding: 8px;
            text-align: left;
            font-weight: 600;
            font-size: 10pt;
        }

        .invoice-table tbody td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10pt;
        }

        .text-center {
            text-align: center;
        }

        .invoice-summary {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .summary-table {
            width: 50%;
            border-collapse: collapse;
        }

        .summary-table td {
            padding: 6px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10pt;
        }

        .summary-table td:first-child {
            text-align: right;
            font-weight: 500;
        }

        .summary-table tr.arrears-row {
            background: #fff3cd;
        }

        .summary-table tr.arrears-row td {
            color: #856404;
            font-weight: 600;
        }

        .summary-table tr.total-row {
            background: #f8f9fa;
            border-top: 2px solid #667eea;
        }

        .summary-table tr.total-row td {
            font-weight: bold;
            font-size: 11pt;
            color: #dc3545;
            padding: 10px 12px;
        }

        .amount-words {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: right;
            font-style: italic;
            font-size: 15pt;
        }

        .alert-warning {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
        }

        .alert-warning p {
            color: #856404;
            margin: 0;
            font-size: 9pt;
        }

        .alert-danger {
            background: #fee;
            padding: 10px;
            border-radius: 4px;
            margin-top: 12px;
            border-left: 4px solid #dc3545;
        }

        .alert-danger p {
            color: #721c24;
            margin: 0;
            font-size: 9pt;
        }

        .payment-instructions {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 15px;
        }

        .momo-instructions h4 {
            text-decoration: underline;
            margin-bottom: 6px;
            font-size: 10pt;
        }

        .momo-instructions p {
            margin-bottom: 5px;
            font-size: 9pt;
        }

        .momo-instructions ol {
            margin-left: 18px;
            font-size: 9pt;
        }

        .momo-code {
            font-weight: bold;
            color: #667eea;
        }

        .signatures {
            flex: 1;
            display: flex;
            justify-content: space-around;
        }

        .signature-box img {
            width: 100px;
            height: 65px;
            object-fit: contain;
        }

        .print-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .print-button {
            background: #667eea;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 12pt;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-button:hover {
            background: #5568d3;
        }

        /* üîß FIXED PRINT STYLES */
        @media print {
            body {
                margin: 0;
                padding: 0;
            }

            .print-container {
                max-width: 100%;
                padding: 5mm;
                page-break-after: avoid;
            }

            .no-print {
                display: none !important;
            }

            .watermark {
                position: fixed !important;
                opacity: 0.05 !important;
            }

            .invoice-header, .bill-info, .invoice-table, 
            .invoice-summary, .payment-instructions, 
            .amount-words, .alert-warning, .alert-danger {
                page-break-inside: avoid;
            }

            @page {
                margin: 10mm;
                size: A4 portrait;
            }
        }
    </style>
</head>
<body>
    <div class="print-button-container no-print">
        <button class="print-button" onclick="window.print()">
            <span>üñ®Ô∏è</span> Print / Save as PDF
        </button>
    </div>

    <!-- üîß FIXED WATERMARK -->
    <div class="watermark">
        <img src="{{ url_for('static', filename='images/ghana_coat_of_arms.png') }}" alt="Watermark">
    </div>

    <div class="print-container">
        <div class="invoice-header">
            <div class="invoice-title">
                <h1>INVOICE</h1>
                <div class="invoice-number">#{{ invoice.invoice_no }}</div>
            </div>
            <div class="company-info">
                <div class="company-address">
                    <strong>AYAWASO WEST MUNICIPAL ASSEMBLY</strong>
                    P O Box YK 1484, KANDA<br>
                    DZORWULU<br>
                    0302-961448<br>
                    GhanaPostGPS: GA-160-8880
                </div>
                <div class="company-logo">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" onerror="this.style.display='none'">
                </div>
            </div>
        </div>

        <div class="bill-info">
            <div class="bill-to">
                <h3>Bill To:</h3>
                <address>
                    <strong>{{ business.owner_name }}</strong><br>
                    Account No: {{ business.account_no }}<br>
                    {% if business.street_name %}{{ business.street_name }}<br>{% endif %}
                    {{ business.electoral_area }}
                </address>
            </div>
            <div class="bill-data">
                <div class="info-line">
                    <strong>Invoice Date:</strong>
                    {% if invoice.invoice_date %}
                        {{ invoice.invoice_date.strftime('%Y-%m-%d') if invoice.invoice_date is not string else invoice.invoice_date }}
                    {% else %}
                        {{ invoice.created_at.strftime('%Y-%m-%d') }}
                    {% endif %}
                </div>
                <div class="info-line">
                    <strong>Due Date:</strong>
                    {% if invoice.due_date %}
                        {{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date is not string else invoice.due_date }}
                    {% else %}
                        {{ invoice.year }}-12-31
                    {% endif %}
                </div>
                <div class="info-line">
                    <strong>Office Contact:</strong> 0302-961642
                </div>
                <p><strong>Bank Details:</strong></p>
                <p>
                    <strong>Bank:</strong> Fidelity Bank<br>
                    <strong>Account No:</strong> 1070032630416<br>
                    <strong>Branch:</strong> Dzorwulu<br>
                    <strong>Swift Code:</strong> FBLIGHAC
                </p>
            </div>
        </div>

        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Invoice Type</th>
                    <th>Business Type</th>
                    <th>Category</th>
                    <!--<th>Category</th>-->
                    <th class="text-center">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>BOP</strong></td>
                    <td>{{ business.category2 or 'N/A' }}</td>
                    <td class="text-center">{{ business.display_category or 'N/A' }}</td>
                    <!--<td>{{ business.category6 or 'N/A' }}</td>-->
                    <td class="text-right"><strong>GHS {{ "{:,.2f}".format(invoice.amount) }}</strong></td>
                </tr>
            </tbody>
        </table>

        {# ============================================
           CALCULATE COMPREHENSIVE FINANCIALS
           ============================================ #}
        {% set invoice_total = invoice.total_amount if invoice.total_amount else invoice.amount %}
        {% set total_paid_current = total_paid %}
        {% set outstanding_before_credit = invoice_total - total_paid_current %}
        {% set available_credit_amount = available_credit if available_credit else 0 %}
        
        {# Apply credit to current invoice #}
        {% set credit_applied_to_current = 0 %}
        {% set outstanding_after_credit = outstanding_before_credit %}
        
        {% if available_credit_amount > 0 and outstanding_before_credit > 0 %}
            {% if available_credit_amount >= outstanding_before_credit %}
                {% set credit_applied_to_current = outstanding_before_credit %}
                {% set outstanding_after_credit = 0 %}
            {% else %}
                {% set credit_applied_to_current = available_credit_amount %}
                {% set outstanding_after_credit = outstanding_before_credit - available_credit_amount %}
            {% endif %}
        {% endif %}
        
        {# Calculate overpayment #}
        {% set overpayment_on_current = 0 %}
        {% if total_paid_current > invoice_total %}
            {% set overpayment_on_current = total_paid_current - invoice_total %}
        {% endif %}
        
        {# Grand total outstanding #}
        {% set grand_total_outstanding = outstanding_after_credit + total_arrears %}
        {% set is_fully_paid = grand_total_outstanding <= 0.01 %}

        <div class="invoice-summary">
            <table class="summary-table">
                <tbody>
                    <tr>
                        <td>Subtotal ({{ invoice.year }})</td>
                        <td>GHS {{ "{:,.2f}".format(invoice.amount) }}</td>
                    </tr>
                    {% if invoice.tax_amount and invoice.tax_amount > 0 %}
                    <tr>
                        <td>Tax ({{ invoice.tax_rate }}%)</td>
                        <td>GHS {{ "{:,.2f}".format(invoice.tax_amount) }}</td>
                    </tr>
                    {% endif %}
                    {% if total_arrears > 0 %}
                    <tr class="arrears-row">
                        <td><strong>Arrears (Previous Years)</strong></td>
                        <td><strong>GHS {{ "{:,.2f}".format(total_arrears) }}</strong></td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td>Payment ({{ invoice.year }})</td>
                        <td>GHS {{ "{:,.2f}".format(total_paid_current) }}</td>
                    </tr>
                    {% if credit_applied_to_current > 0 %}
                    <tr style="background: #e8f5e9;">
                        <td><strong>üí≥ Credit Applied</strong></td>
                        <td><strong style="color: #2e7d32;">- GHS {{ "{:,.2f}".format(credit_applied_to_current) }}</strong></td>
                    </tr>
                    {% endif %}
                    {% if overpayment_on_current > 0 %}
                    <tr style="background: #fff9e6;">
                        <td><strong>üí∞ Overpayment</strong></td>
                        <td><strong style="color: #856404;">GHS {{ "{:,.2f}".format(overpayment_on_current) }}</strong></td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td>Penalty</td>
                        <td>GHS 0.00</td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>TOTAL OUTSTANDING</strong></td>
                        <td>
                            {% if is_fully_paid %}
                                <strong style="color: #16a34a;">GHS 0.00 (PAID ‚úì)</strong>
                            {% else %}
                                <strong>GHS {{ "{:,.2f}".format(grand_total_outstanding) }}</strong>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="amount-words">
            {% if is_fully_paid %}
                Zero Ghana Cedis only (Fully Paid{% if credit_applied_to_current > 0 %} - Credit of GHS {{ "{:,.2f}".format(credit_applied_to_current) }} applied{% endif %}{% if overpayment_on_current > 0 %} - Overpayment: GHS {{ "{:,.2f}".format(overpayment_on_current) }} available as credit{% endif %})
            {% else %}
                {{ grand_total_outstanding | in_words }}{% if credit_applied_to_current > 0 %} (After GHS {{ "{:,.2f}".format(credit_applied_to_current) }} credit applied){% endif %}
            {% endif %}
        </div>

        {# Credit Applied Notice #}
        {% if credit_applied_to_current > 0 %}
        <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 12px; border-left: 4px solid #4caf50;">
            <p style="color: #2e7d32; margin: 0; font-size: 9pt;">
                <strong>üí≥ Credit Applied:</strong> A credit balance of 
                <strong>GHS {{ "{:,.2f}".format(credit_applied_to_current) }}</strong> from previous overpayments 
                has been applied to this invoice, reducing your outstanding balance.
            </p>
        </div>
        {% endif %}

        {# Overpayment Notice #}
        {% if overpayment_on_current > 0 %}
        <div class="alert-warning">
            <p>
                <strong>üí∞ Overpayment Recorded:</strong> This invoice has received 
                <strong>GHS {{ "{:,.2f}".format(overpayment_on_current) }}</strong> more than the invoice amount. 
                This excess will be available as credit for future invoices.
            </p>
        </div>
        {% endif %}

        {# Arrears Warning (only if no credit/overpayment notices) #}
        {% if total_arrears > 0 and credit_applied_to_current == 0 and overpayment_on_current == 0 %}
        <div class="alert-warning">
            <p>
                <strong>‚ö†Ô∏è Outstanding Arrears:</strong> This invoice includes 
                <strong>GHS {{ "{:,.2f}".format(total_arrears) }}</strong> in unpaid arrears 
                from {{ arrears_breakdown|length }} previous invoice(s). 
                Please settle all outstanding amounts.
            </p>
        </div>
        {% endif %}

        <div class="payment-instructions">
            <div class="momo-instructions">
                <h4>Mobile Money Payment Instructions</h4>
                <p><strong>Momo Code:</strong> <span class="momo-code">2503</span></p>
                <ol>
                    <li>Dial <strong>*776*100#</strong> on MTN, Vodafone and Airtel/Tigo</li>
                    <li>Enter merchant code: <strong>2503</strong></li>
                    <li>Merchant details will be displayed</li>
                    <li>Enter amount</li>
                    <li>Enter narration - Include your Account Number: <strong>{{ business.account_no }}</strong></li>
                    <li>Confirm payment with Momo PIN</li>
                </ol>
            </div>
            <div class="signatures">
                <div class="signature-box">
                    <img src="{{ url_for('static', filename='images/MFO_signature.jpg') }}" alt="MFO Signature" onerror="this.style.display='none'">
                </div>
                <div class="signature-box">
                    <img src="{{ url_for('static', filename='images/MCD_signature.jpg') }}" alt="MCD Signature" onerror="this.style.display='none'">
                </div>
            </div>
        </div>

        <div class="alert-danger">
            <p>
                <strong>‚ö†Ô∏è Important:</strong> Payment should be made at the Revenue Office or at the Assembly's Revenue Collector or the Bank or Mobile money details on this bill. Legal action shall be taken against defaulters after 31st March upon receipt of bill.
            </p>
        </div>
    </div>
</body>
</html>