<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Print - {{ invoices_data|length }} Invoices</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #333;
            background: #fff;
            overflow-x: hidden;
        }

        /* üñ®Ô∏è PRINT HEADER (No Print) */
        .print-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .print-header .info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .print-header .info i {
            font-size: 1.5rem;
        }

        .print-header button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-print {
            background: white;
            color: #667eea;
        }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-left: 0.5rem;
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* üìÑ PRINT CONTENT */
        .print-content {
            margin-top: 80px;
        }

        .invoice-page {
            page-break-after: always;
            max-width: 210mm;
            margin: 0 auto 2rem;
            padding: 10mm;
            background: #fff;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .invoice-page:last-child {
            page-break-after: auto;
        }

        /* üåä WATERMARK */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.08;
            z-index: -1;
            pointer-events: none;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watermark img {
            width: 450px;
            height: auto;
            max-width: 60%;
        }

        /* üìã INVOICE HEADER */
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .invoice-title h1 {
            font-size: 28pt;
            color: #667eea;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .invoice-title .invoice-number {
            font-size: 16pt;
            color: #333;
            font-weight: 600;
        }

        .company-info {
            text-align: right;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            gap: 12px;
        }

        .company-address {
            text-align: right;
            line-height: 1.5;
            font-size: 10pt;
        }

        .company-address strong {
            display: block;
            font-size: 10pt;
            margin-bottom: 3px;
        }

        .company-logo img {
            width: 75px;
            height: 75px;
            object-fit: contain;
        }

        /* üë§ BILL INFO */
        .bill-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 20px;
        }

        .bill-to h3, .bill-data h3 {
            font-size: 11pt;
            color: #667eea;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .bill-to address {
            font-style: normal;
            line-height: 1.5;
            font-size: 10pt;
        }

        .info-line {
            margin-bottom: 3px;
            font-size: 10pt;
        }

        .info-line strong {
            display: inline-block;
            min-width: 110px;
        }

        .bill-data p {
            margin-bottom: 3px;
            font-size: 10pt;
        }

        /* üìä INVOICE TABLE */
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .invoice-table thead {
            background: #667eea;
            color: #fff;
        }

        .invoice-table th {
            padding: 8px;
            text-align: left;
            font-weight: 600;
            font-size: 10pt;
        }

        .invoice-table tbody td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10pt;
        }

        .text-center {
            text-align: center;
        }

        /* üí∞ INVOICE SUMMARY */
        .invoice-summary {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .summary-table {
            width: 50%;
            border-collapse: collapse;
        }

        .summary-table td {
            padding: 6px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10pt;
        }

        .summary-table td:first-child {
            text-align: right;
            font-weight: 500;
        }

        .summary-table tr.arrears-row {
            background: #fff3cd;
        }

        .summary-table tr.arrears-row td {
            color: #856404;
            font-weight: 600;
        }

        .summary-table tr.total-row {
            background: #f8f9fa;
            border-top: 2px solid #667eea;
        }

        .summary-table tr.total-row td {
            font-weight: bold;
            font-size: 11pt;
            color: #dc3545;
            padding: 10px 12px;
        }

        .amount-words {
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: right;
            font-style: italic;
            font-size: 15pt;
        }

        /* ‚ö†Ô∏è ALERTS */
        .alert-warning {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
        }

        .alert-warning p {
            color: #856404;
            margin: 0;
            font-size: 9pt;
        }

        .alert-danger {
            background: #fee;
            padding: 10px;
            border-radius: 4px;
            margin-top: 12px;
            border-left: 4px solid #dc3545;
        }

        .alert-danger p {
            color: #721c24;
            margin: 0;
            font-size: 9pt;
        }

        /* üì± PAYMENT INSTRUCTIONS */
        .payment-instructions {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .momo-instructions h4 {
            text-decoration: underline;
            margin-bottom: 6px;
            font-size: 10pt;
        }

        .momo-instructions p {
            margin-bottom: 5px;
            font-size: 9pt;
        }

        .momo-instructions ol {
            margin-left: 18px;
            font-size: 9pt;
        }

        .momo-code {
            font-weight: bold;
            color: #667eea;
        }

        .signatures {
            flex: 1;
            display: flex;
            justify-content: space-around;
        }

        .signature-box img {
            width: 100px;
            height: 65px;
            object-fit: contain;
        }

        /* üñ®Ô∏è PRINT STYLES */
        @media print {
            body {
                margin: 0;
                padding: 0;
            }

            .print-header {
                display: none !important;
            }

            .print-content {
                margin-top: 0;
            }

            .invoice-page {
                max-width: 100%;
                padding: 5mm;
                box-shadow: none;
                margin-bottom: 0;
                page-break-after: always;
            }

            .invoice-page:last-child {
                page-break-after: auto;
            }

            .no-print {
                display: none !important;
            }

            .watermark {
                position: fixed !important;
                opacity: 0.05 !important;
            }

            .invoice-header, .bill-info, .invoice-table, 
            .invoice-summary, .payment-instructions, 
            .amount-words, .alert-warning, .alert-danger {
                page-break-inside: avoid;
            }

            @page {
                margin: 10mm;
                size: A4 portrait;
            }
        }
    </style>
</head>
<body>
    <div class="print-header no-print">
        <div class="info">
            <i class="fas fa-file-invoice-dollar"></i>
            <div>
                <strong style="font-size: 1.1rem;">{{ invoices_data|length }}</strong> invoice(s) ready to print
            </div>
        </div>
        <div>
            <button onclick="window.print()" class="btn-print">
                üñ®Ô∏è Print All Invoices
            </button>
            <button onclick="window.close()" class="btn-close">
                ‚úï Close
            </button>
        </div>
    </div>

    <div class="watermark">
        <img src="{{ url_for('static', filename='images/ghana_coat_of_arms.png') }}" alt="Watermark">
    </div>

    <div class="print-content">
        {% for item in invoices_data %}
        <div class="invoice-page">
            <!-- Invoice Header -->
            <div class="invoice-header">
                <div class="invoice-title">
                    <h1>INVOICE</h1>
                    <div class="invoice-number">#{{ item.invoice.invoice_no }}</div>
                </div>
                <div class="company-info">
                    <div class="company-address">
                        <strong>AYAWASO WEST MUNICIPAL ASSEMBLY</strong>
                        P O Box YK 1484, KANDA<br>
                        DZORWULU<br>
                        0302-961448<br>
                        GhanaPostGPS: GA-160-8880
                    </div>
                    <div class="company-logo">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>

            <!-- Bill Info -->
            <div class="bill-info">
                <div class="bill-to">
                    <h3>Bill To:</h3>
                    <address>
                        {% if item.type == 'Property' %}
                        <strong>{{ item.entity.owner_name }}</strong><br>
                        Account No: {{ item.entity.account_no }}<br>
                        {% if item.entity.street_name %}{{ item.entity.street_name }}<br>{% endif %}
                        {{ item.entity.electoral_area }}
                        {% else %}
                        <strong>{{ item.entity.business_name }}</strong><br>
                        Owner: {{ item.entity.owner_name }}<br>
                        Account No: {{ item.entity.account_no }}<br>
                        {% if item.entity.street_name %}{{ item.entity.street_name }}<br>{% endif %}
                        {{ item.entity.electoral_area }}
                        {% endif %}
                    </address>
                </div>
                <div class="bill-data">
                    <div class="info-line">
                        <strong>Invoice Date:</strong>
                        {% if item.invoice.invoice_date %}
                            {{ item.invoice.invoice_date.strftime('%Y-%m-%d') if item.invoice.invoice_date is not string else item.invoice.invoice_date }}
                        {% else %}
                            {{ item.invoice.created_at.strftime('%Y-%m-%d') }}
                        {% endif %}
                    </div>
                    <div class="info-line">
                        <strong>Due Date:</strong>
                        {% if item.invoice.due_date %}
                            {{ item.invoice.due_date.strftime('%Y-%m-%d') if item.invoice.due_date is not string else item.invoice.due_date }}
                        {% else %}
                            {{ item.invoice.year }}-12-31
                        {% endif %}
                    </div>
                    <div class="info-line">
                        <strong>Office Contact:</strong> 0302-961642
                    </div>
                    <p><strong>Bank Details:</strong></p>
                    <p>
                        <strong>Bank:</strong> Fidelity Bank<br>
                        <strong>Account No:</strong> 1070032630416<br>
                        <strong>Branch:</strong> Dzorwulu<br>
                        <strong>Swift Code:</strong> FBLIGHAC
                    </p>
                </div>
            </div>

            <!-- Invoice Items -->
            <table class="invoice-table">
                <thead>
                    <tr>
                        {% if item.type == 'Property' %}
                        <th>Invoice Type</th>
                        <th>Rateable Value</th>
                        <th>Rate Impost</th>
                        <th class="text-center">Amount</th>
                        {% else %}
                        <th>Invoice Type</th>
                        <th>Business Type</th>
                        <th>Category</th>
                        <th class="text-center">Amount</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% if item.type == 'Property' %}
                        <td><strong>PROPERTY RATE</strong></td>
                        <td>GHS {{ "{:,.2f}".format(item.invoice.rateable_value) }}</td>
                        <td class="text-center">{{ "{:.6f}".format(item.invoice.rate_impost) }}</td>
                        <td class="text-center"><strong>GHS {{ "{:,.2f}".format(item.invoice.amount) }}</strong></td>
                        {% else %}
                        <td><strong>BOP</strong></td>
                        <td>{{ item.entity.category2 or 'N/A' }}</td>
                        <td>{{ item.entity.category4 or 'N/A' }}</td>
                        <td class="text-center"><strong>GHS {{ "{:,.2f}".format(item.invoice.amount) }}</strong></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>

            <!-- Invoice Summary -->
            {% set invoice_total = item.invoice.total_amount if item.invoice.total_amount else item.invoice.amount %}
            {% set current_invoice_balance = invoice_total - item.total_paid %}
            {% set grand_total_outstanding = current_invoice_balance + item.total_arrears %}

            <div class="invoice-summary">
                <table class="summary-table">
                    <tbody>
                        <tr>
                            <td>Subtotal ({{ item.invoice.year }})</td>
                            <td>GHS {{ "{:,.2f}".format(item.invoice.amount) }}</td>
                        </tr>
                        {% if item.invoice.tax_amount and item.invoice.tax_amount > 0 %}
                        <tr>
                            <td>Tax ({{ item.invoice.tax_rate }}%)</td>
                            <td>GHS {{ "{:,.2f}".format(item.invoice.tax_amount) }}</td>
                        </tr>
                        {% endif %}
                        <tr class="arrears-row">
                            <td><strong>Arrears (Previous Years)</strong></td>
                            <td><strong>GHS {{ "{:,.2f}".format(item.total_arrears) }}</strong></td>
                        </tr>
                        <tr>
                            <td>Payment ({{ item.invoice.year }})</td>
                            <td>GHS {{ "{:,.2f}".format(item.total_paid) }}</td>
                        </tr>
                        <tr>
                            <td>Penalty</td>
                            <td>GHS 0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>TOTAL OUTSTANDING</strong></td>
                            <td><strong>GHS {{ "{:,.2f}".format(grand_total_outstanding) }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="amount-words">
                {{ grand_total_outstanding | in_words }}
            </div>

            {% if item.total_arrears > 0 %}
            <div class="alert-warning">
                <p>
                    <strong>‚ö†Ô∏è Outstanding Arrears:</strong> This invoice includes 
                    <strong>GHS {{ "{:,.2f}".format(item.total_arrears) }}</strong> in unpaid arrears 
                    from previous invoice(s). 
                    Please settle all outstanding amounts.
                </p>
            </div>
            {% endif %}

            <div class="payment-instructions">
                <div class="momo-instructions">
                    <h4>Mobile Money Payment Instructions</h4>
                    <p><strong>Momo Code:</strong> <span class="momo-code">2503</span></p>
                    <ol>
                        <li>Dial <strong>*776*100#</strong> on MTN, Vodafone and Airtel/Tigo</li>
                        <li>Enter merchant code: <strong>2503</strong></li>
                        <li>Merchant details will be displayed</li>
                        <li>Enter amount</li>
                        <li>Enter narration - Include your Account Number: <strong>{% if item.type == 'Property' %}{{ item.entity.account_no }}{% else %}{{ item.entity.account_no }}{% endif %}</strong></li>
                        <li>Confirm payment with Momo PIN</li>
                    </ol>
                </div>
                <div class="signatures">
                    <div class="signature-box">
                        <img src="{{ url_for('static', filename='images/MFO_signature.jpg') }}" alt="MFO Signature" onerror="this.style.display='none'">
                    </div>
                    <div class="signature-box">
                        <img src="{{ url_for('static', filename='images/MCD_signature.jpg') }}" alt="MCD Signature" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>

            <div class="alert-danger">
                <p>
                    <strong>‚ö†Ô∏è Important:</strong> Payment should be made at the Revenue Office or at the Assembly's Revenue Collector or the Bank or Mobile money details on this bill. Legal action shall be taken against defaulters after 31st March upon receipt of bill.
                </p>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        // Auto-print option
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auto_print') === 'true') {
            window.onload = function() {
                window.print();
            };
        }
    </script>
</body>
</html>