{% extends "base.html" %}

{% block title %}Businesses List{% endblock %}

{% block extra_css %}
<style>
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0;
    }

    .table th, .table td {
        padding: 1rem 1.5rem;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
    }

    .table thead tr {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    .table tbody tr:hover {
        background: #f9fafb;
    }
    
    .table tbody tr.selected {
        background: #e0e7ff !important;
    }

    .table-responsive {
        width: 100%;
        overflow-x: auto;
    }
    
    .search-area {
        padding: 1.5rem; 
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #e0e0e0;
    }
    
    .search-box {
        position: relative;
        display: flex;
        gap: 1rem;
        max-width: 100%;
    }
    
    .search-area input[type="text"] {
        flex: 1;
        padding: 0.875rem 3rem 0.875rem 1rem;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .search-area input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Bulk Actions Bar */
    .bulk-actions-bar {
        display: none;
        padding: 1rem 1.5rem;
        background: #fef3c7;
        border-bottom: 2px solid #fbbf24;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .bulk-actions-bar.active {
        display: flex;
    }
    
    .bulk-actions-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .bulk-actions-info strong {
        color: #92400e;
    }
    
    .bulk-actions-buttons {
        display: flex;
        gap: 0.75rem;
    }
    
    .btn-bulk-delete {
        background: #dc2626;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-bulk-delete:hover {
        background: #991b1b;
    }
    
    .btn-clear-selection {
        background: #6b7280;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-clear-selection:hover {
        background: #4b5563;
    }
    
    /* Checkbox Styles */
    .select-checkbox, .select-all-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #667eea;
    }
    
    .results-summary {
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .results-summary strong {
        color: #667eea;
    }
    
    .pagination {
        list-style: none;
        display: flex;
        padding-left: 0;
        border-radius: 0.25rem;
        gap: 0.5rem;
    }

    .page-item {
        display: inline-block;
    }

    .page-link {
        position: relative;
        display: block;
        padding: 0.5rem 0.875rem;
        text-decoration: none;
        color: #667eea;
        background-color: #fff;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        transition: all 0.3s;
        font-weight: 500;
    }

    .page-link:hover {
        z-index: 2;
        color: #fff;
        background-color: #667eea;
        border-color: #667eea;
    }

    .page-item.active .page-link {
        z-index: 3;
        color: #fff;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }
    
    .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
        opacity: 0.5;
    }
    
    .delete-link {
        color: #dc3545; 
        background: none; 
        border: none; 
        cursor: pointer; 
        text-decoration: none; 
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.2s;
    }
    .delete-link:hover {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .empty-state {
        padding: 3rem; 
        color: #999;
        text-align: center;
    }
    
    .empty-state i {
        font-size: 3rem;
        display: block;
        margin-bottom: 1rem;
        color: #d1d5db;
    }
    
    .empty-state h3 {
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .empty-state a {
        color: #667eea;
        font-weight: 600;
        text-decoration: none;
    }
    
    .empty-state a:hover {
        text-decoration: underline;
    }
    
    .pagination-container {
        padding: 1.5rem;
        display: flex;
        justify-content: center;
        border-top: 1px solid #e5e7eb;
    }
    
    /* âœ… NEW: Filter Controls */
    .filter-controls {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        flex-wrap: wrap;
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-group label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #495057;
    }
    
    .filter-group input[type="date"],
    .filter-group select {
        padding: 0.5rem;
        border: 2px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.3s;
        min-width: 150px;
    }
    
    .filter-group input[type="date"]:focus,
    .filter-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .filter-actions {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }
    
    .btn-filter {
        padding: 0.5rem 1rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-filter:hover {
        background: #5568d3;
    }
    
    .btn-clear-filter {
        padding: 0.5rem 1rem;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-clear-filter:hover {
        background: #5a6268;
    }
    
    .per-page-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
    }
    
    .per-page-selector label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
    }
    
    .per-page-selector select {
        padding: 0.5rem;
        border: 2px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    .active-filters {
        padding: 0.75rem 1.5rem;
        background: #fff3cd;
        border-bottom: 1px solid #ffc107;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: white;
        border: 1px solid #ffc107;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #856404;
    }
    
    .filter-tag strong {
        color: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-building"></i> Business Operating Permit</h2>
        <div style="display: flex; gap: 0.75rem;">
            <a href="{{ url_for('create_business') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Add Business
            </a>
            <a href="{{ url_for('bulk_upload_businesses') }}" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Bulk Upload
            </a>
        </div>
    </div>
    
    <!-- âœ… NEW: Filter Controls -->
    <div class="filter-controls">
        <form method="GET" action="{{ url_for('list_businesses') }}" style="display: contents;">
            <div class="filter-group">
                <label for="date_from">
                    <i class="fas fa-calendar-alt"></i> Start Date
                </label>
                <input type="date" 
                       id="date_from" 
                       name="date_from" 
                       value="{{ date_from }}"
                       max="{{ today_date() }}">
            </div>
            
            <div class="filter-group">
                <label for="date_to">
                    <i class="fas fa-calendar-alt"></i> End Date
                </label>
                <input type="date" 
                       id="date_to" 
                       name="date_to" 
                       value="{{ date_to }}"
                       max="{{ today_date() }}">
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn-filter">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                
                {% if date_from or date_to %}
                <a href="{{ url_for('list_businesses') }}" class="btn-clear-filter">
                    <i class="fas fa-times"></i> Clear
                </a>
                {% endif %}
            </div>
            
            <!-- âœ… NEW: Per Page Selector -->
            <div class="per-page-selector">
                <label for="per_page">Show:</label>
                <select id="per_page" name="per_page" onchange="this.form.submit()">
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                </select>
            </div>
            
            <!-- Hidden field to preserve search -->
            {% if search %}
            <input type="hidden" name="search" value="{{ search }}">
            {% endif %}
        </form>
    </div>
    
    <!-- âœ… NEW: Active Filters Display -->
    {% if date_from or date_to %}
    <div class="active-filters">
        <strong><i class="fas fa-filter"></i> Active Filters:</strong>
        {% if date_from %}
        <span class="filter-tag">
            <strong>From:</strong> {{ date_from }}
        </span>
        {% endif %}
        {% if date_to %}
        <span class="filter-tag">
            <strong>To:</strong> {{ date_to }}
        </span>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <div class="bulk-actions-info">
            <strong><span id="selectedCount">0</span> selected</strong>
        </div>
        <div class="bulk-actions-buttons">
            <button onclick="clearSelection()" class="btn-clear-selection">
                <i class="fas fa-times"></i> Clear Selection
            </button>
            <button onclick="bulkDeleteBusinesses()" class="btn-bulk-delete">
                <i class="fas fa-trash-alt"></i> Delete Selected
            </button>
        </div>
    </div>
    
    <div class="search-area">
        <div class="search-box">
            <input type="text" 
                   name="search" 
                   placeholder="ðŸ” Type to search businesses in real-time..." 
                   value="{{ search }}"
                   autocomplete="off">
        </div>
    </div>
    
    {% if pagination %}
    <div class="results-summary">
        <div>
            <strong>Total Businesses: {{ pagination.total }}</strong>
            {% if date_from or date_to %}
            <span style="color: #666; font-size: 0.9rem;">(filtered results)</span>
            {% endif %}
        </div>
        <div style="color: #666;">
            Page {{ pagination.page }} of {{ pagination.pages }} | Showing {{ per_page }} per page
        </div>
    </div>
    {% endif %}
    
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 50px;">
                        <input type="checkbox" class="select-all-checkbox" id="selectAll">
                    </th>
                    <th>Account No</th>
                    <th>Business Name</th>
                    <th>Owner</th>
                    <th>Location</th>
                    <th>Category 1</th>
                    <th>Category 2</th>
                    <th>Category 3</th>
                    <th>Category 4</th>
                    <th>Category 5</th>
                    <th>Category 6</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if pagination and pagination.items %}
                    {% for business in pagination.items %}
                    <tr data-business-id="{{ business.id }}">
                        <td>
                            <input type="checkbox" class="select-checkbox" value="{{ business.id }}">
                        </td>
                        <td>
                            <a href="{{ url_for('view_business', id=business.id) }}" 
                               style="color: #667eea; text-decoration: none; font-weight: 600;">
                                {{ business.account_no }}
                            </a>
                        </td>
                        <td>{{ business.business_name }}</td>
                        <td>{{ business.owner_name }}</td>
                        <td>{{ business.town }}, {{ business.electoral_area }}</td>
                        <td>{{ business.category1 or '-' }}</td>
                        <td>{{ business.category2 or '-' }}</td>
                        <td>{{ business.category3 or '-' }}</td>
                        <td>{{ business.category4 or '-' }}</td>
                        <td>{{ business.category5 or '-' }}</td>
                        <td>{{ business.category6 or '-' }}</td>
                        <td>
                            <a href="{{ url_for('view_business', id=business.id) }}" 
                               class="btn btn-secondary" 
                               style="padding: 0.5rem 0.8rem; font-size: 0.85rem; margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <button onclick="deleteBusiness({{ business.id }}, '{{ business.account_no }}', '{{ business.business_name }}')" 
                                    class="delete-link">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    <tr class="empty-state" style="display: none;">
                        <td colspan="12">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>No Businesses Found</h3>
                                <p>Try adjusting your search</p>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr class="empty-state">
                        <td colspan="12">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>No Businesses Yet</h3>
                                <p>Get started by <a href="{{ url_for('create_business') }}">adding your first business</a></p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    {% if pagination and pagination.pages > 1 %}
    <div class="pagination-container">
        <nav>
            <ul class="pagination">
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                    <a class="page-link" href="{{ url_for('list_businesses', page=pagination.prev_num, search=search, date_from=date_from, date_to=date_to, per_page=per_page) if pagination.has_prev else '#' }}">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </li>
                
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {{ 'active' if page_num == pagination.page }}">
                            <a class="page-link" href="{{ url_for('list_businesses', page=page_num, search=search, date_from=date_from, date_to=date_to, per_page=per_page) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                
                <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                    <a class="page-link" href="{{ url_for('list_businesses', page=pagination.next_num, search=search, date_from=date_from, date_to=date_to, per_page=per_page) if pagination.has_next else '#' }}">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
// Selection Management
let selectedBusinesses = new Set();

function updateBulkActionsBar() {
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    selectedCount.textContent = selectedBusinesses.size;
    
    if (selectedBusinesses.size > 0) {
        bulkActionsBar.classList.add('active');
    } else {
        bulkActionsBar.classList.remove('active');
    }
}

function updateRowSelection() {
    document.querySelectorAll('.select-checkbox').forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    });
}

// Select All functionality
document.getElementById('selectAll')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.select-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
        const businessId = parseInt(checkbox.value);
        if (e.target.checked) {
            selectedBusinesses.add(businessId);
        } else {
            selectedBusinesses.delete(businessId);
        }
    });
    updateBulkActionsBar();
    updateRowSelection();
});

// Individual checkbox selection
document.querySelectorAll('.select-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const businessId = parseInt(this.value);
        if (this.checked) {
            selectedBusinesses.add(businessId);
        } else {
            selectedBusinesses.delete(businessId);
        }
        
        // Update "Select All" checkbox
        const selectAllCheckbox = document.getElementById('selectAll');
        const allCheckboxes = document.querySelectorAll('.select-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.select-checkbox:checked');
        selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
        
        updateBulkActionsBar();
        updateRowSelection();
    });
});

function clearSelection() {
    selectedBusinesses.clear();
    document.querySelectorAll('.select-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateBulkActionsBar();
    updateRowSelection();
}

function bulkDeleteBusinesses() {
    if (selectedBusinesses.size === 0) {
        alert('Please select businesses to delete');
        return;
    }
    
    const confirmMessage = `Are you sure you want to delete ${selectedBusinesses.size} businesses?\n\nThis will also delete all associated invoices and payments.\n\nThis action cannot be undone.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Show loading state
    const deleteBtn = document.querySelector('.btn-bulk-delete');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    deleteBtn.disabled = true;
    
    // Send delete request
    fetch('/business/bulk-delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            business_ids: Array.from(selectedBusinesses)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting businesses');
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
}

function deleteBusiness(id, accountNo, businessName) {
    if (confirm(`Are you sure you want to delete business "${businessName}" (Account: ${accountNo})?\n\nThis will also delete all associated invoices and cannot be undone.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/business/delete/${id}`; 
        document.body.appendChild(form);
        form.submit();
    }
}

// Real-Time Search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    const tableBody = document.querySelector('table tbody');
    const resultsInfo = document.querySelector('.results-summary > div:first-child');
    
    if (!searchInput || !tableBody) return;
    
    const allRows = Array.from(tableBody.querySelectorAll('tr:not(.empty-state)'));
    const emptyStateRow = tableBody.querySelector('.empty-state');
    
    // Create clear button
    const clearButton = document.createElement('button');
    clearButton.type = 'button';
    clearButton.innerHTML = '<i class="fas fa-times-circle"></i>';
    clearButton.style.cssText = `
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 0.5rem;
        display: none;
        font-size: 1.2rem;
    `;
    searchInput.parentElement.appendChild(clearButton);
    
    function filterRows(searchTerm) {
        searchTerm = searchTerm.toLowerCase().trim();
        let visibleCount = 0;
        
        allRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const text = [
                cells[1]?.textContent || '',  // Account No
                cells[2]?.textContent || '',  // Business Name
                cells[3]?.textContent || '',  // Owner
                cells[4]?.textContent || '',  // Location
                cells[5]?.textContent || '',  // Category 1
                cells[6]?.textContent || '',  // Category 2
                cells[7]?.textContent || '',  // Category 3
                cells[8]?.textContent || '',  // Category 4
                cells[9]?.textContent || '',  // Category 5
                cells[10]?.textContent || ''  // Category 6
            ].join(' ').toLowerCase();
            
            if (!searchTerm || text.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        if (resultsInfo) {
            if (searchTerm) {
                resultsInfo.innerHTML = `<strong>Showing ${visibleCount} of ${allRows.length} businesses</strong> <span style="color: #666;">| "${searchTerm}"</span>`;
            } else {
                resultsInfo.innerHTML = `<strong>Total Businesses: ${allRows.length}</strong>`;
            }
        }
        
        if (emptyStateRow) {
            emptyStateRow.style.display = (visibleCount === 0 && searchTerm) ? '' : 'none';
        }
        
        clearButton.style.display = searchTerm ? 'block' : 'none';
    }
    
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }
    
    searchInput.addEventListener('input', debounce((e) => filterRows(e.target.value), 300));
    clearButton.addEventListener('click', () => {
        searchInput.value = '';
        filterRows('');
        searchInput.focus();
    });
    
    if (searchInput.value) filterRows(searchInput.value);
});
</script>
{% endblock %}